# All in Graph

All in Graph 是一个将“文字对话”和“图形交互”并行融合的桌面原型项目。它通过可嵌套的画布、结构化的图谱表达和 AI 主动维护能力，帮助用户在复杂主题下更清晰地组织信息、追踪上下文，并让答案与结构同步呈现。

## 项目目标
- 在传统聊天界面（右侧）保持完整的自然语言对话，同时在中间画布以节点/连线表示概念与关系。
- 支持节点展开为独立画布（主画布 → 子画布 → 多层嵌套），并以树形结构查看层级。
- AI 在回答问题时同步更新图结构（新增说明节点、关系边、布局优化），让“答案 + 图更新”形成闭环。

## 关键特性
- 会话与主画布绑定：左侧为会话列表，每个会话拥有一个主画布，互不干扰；聊天记录也按会话独立保存。
- 图形编辑与交互：
  - 节点/连线基础操作、框选与选中高亮、节点大小调整、拖拽记录位置历史。
  - 双击节点进入其子画布；连线支持双击尝试进入对应关系的子视图（可扩展）。
  - 右键菜单仅保留“解释”入口：对节点/连线发起 AI 解释并将结果写入聊天框，同时在画布中生成说明节点与连接边。
- 画布与视角：
  - 中键拖拽平移（含惯性），滚轮居中缩放（平滑缓动，范围 0.1–10x）。
  - 进入树面板时画布区域变暗过渡；点击空白处可取消面板。
- 智能布局与碰撞避免：
  - 新增节点时进行碰撞检测，保证与现有节点保持最小 50px 间距；近邻采样 → 力导向偏移 → 网格回退三段式放置。
- Markdown/LaTeX 支持：
  - 聊天与节点说明支持 Markdown；节点标签内嵌 KaTeX 渲染公式。

## 技术栈与架构
- 前端：纯静态原型（`web/`），使用原生 SVG + JavaScript；UI 布局与主题在 `styles.css`。
- 视图分层：`#viewport` 组应用平移/缩放；`#rootG` 承载图元素（节点/边/标签）。
- 会话模型：在 `state.sessionStore` 中保存每个会话的图与层级；`state.sessionChats` 保存会话聊天记录；`sessions-list` 展示会话项。
- AI 调用：提供 `callAI(payload)`（原型使用 `/api/ai/chat`），并内置 `mockAI(payload)` 以离线演示；解释流程统一经 `explainTarget(target)`。

## 目录结构
```
all-in-graph/
  web/
    index.html      # 三栏布局与静态资源引入
    styles.css      # 主题与交互样式
    main.js         # 画布渲染、交互、AI解释与会话管理
  scripts/
    server.ps1      # 轻量 PowerShell 静态服务器（可选）
  docs/
    all-in-graph-设计文档.md  # 详细架构与实现说明
  README.md
```

## 快速启动
- 方式一（推荐，需本地 Python）：
  1. 在项目根目录运行：`python -m http.server 8090 --directory web`
  2. 打开浏览器访问：`http://localhost:8090/`
- 方式二（PowerShell）：
  1. 运行：`powershell -ExecutionPolicy Bypass -File scripts/server.ps1 -Port 8090 -Root web`
  2. 打开：`http://localhost:8090/`

## 使用指引
- 左侧会话
  - 点击“新建会话”创建固定标题为“新会话”的会话（原子创建其主画布）。
  - 点击会话项切换当前会话；右键会话项支持重命名与删除。
- 中间画布
  - 单击节点/连线选中；右键“解释”触发 AI 请求，答案写入右侧聊天框，同时在画布生成说明节点与连接边。
  - 双击节点进入子画布；点击“返回上一层”回到上一画布；双击会话可显示树形层级面板。
  - 框选以红色矩形出现，支持批量选中；大小与拖动均保持 60fps 交互节奏。
  - 中键拖拽平移；滚轮居中缩放（缓动动画）；双击中键重置视角。
- 右侧聊天
  - 每个会话拥有独立聊天框；用户与 AI 消息按会话隔离显示；支持 Markdown/KaTeX。

## AI 解释与图更新
- 节点解释：在节点旁（逻辑定位）生成说明节点，连接边命名为“解释”；聊天区打印解释全文。
- 连线解释：在连线中点附近生成“关系说明”节点，并以“说明”边与源节点连接；聊天区打印解释全文。
- 请求失败：在聊天区显示友好错误提示，图保持原状。

## 交互与性能策略
- 事件去重与节流：滚轮缩放采用令牌取消前次动画，避免偏移跳变；拖拽与选择过程中只更新必要属性。
- 坐标系统：`screenCTM` 逆变换实现屏幕 ↔ SVG 坐标映射；缩放以画布中心为基准。
- 布局与碰撞：近邻采样 + 力导向偏移 + 网格回退；最小间距阈值 50px，确保清晰可读。

## 常见问题
- 看不到树形层级面板：双击左侧会话或“主画布”入口；出现后点击画布空白可关闭。
- 右键没有菜单：请确认在节点中心内容区或连线名称处右键；透明命中层 `.edge-hit` 也支持右键。
- 解释结果位置：答案只在聊天框中打印；图中展示为新增说明节点与边，不再将解释文本直接显示在鼠标位置。

## 路线图（原型 → 项目）
- 引入图引擎（如 AntV G6）以获得更强布局与大图性能。
- 正式接入 AI 服务（OpenAI/Anthropic/DeepSeek/本地 LLM），统一工具函数与 GraphDelta。
- 多会话持久化与导出，支持缩略图预览与最近更新时间。
- 更丰富的说明样式（淡色卡片、可关闭、拖动、批量对齐）。


